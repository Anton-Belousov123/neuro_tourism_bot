# Описание Neuro Tourism Bot'a

### Файлы:
```
.env - файл хранящий секретные данные
amo.py - логика связанная с общением amocrm
config.json - конфиг скрипта (на момент написания документации хранит pipelines, от которых читать сообщения
db.json - База данных историй сообщений
db.py - Файл для общения с базой данных
google.json - файл получаемый от Google для таблиц
main.py - файл в котором происходит вся логика
misc.py - файл с переводчиком, определителем русского языка и получением данных от гугла
Readme.md - документация, которую вы читаете ;)
rq.txt - зависимости проекта
```


### Как взаимодействовать с сервером:
```
screen -r gptbot (если окно уже создано)
screen -S gptbot (создаст рабочее окно)
python3 main.py
```

### Логика:
1) Сервер получает новое сообщение от amocrm по api (адрес отправления указывается в ```https://chatgpt.amocrm.ru/amo-market/ -> webhooks```)
2) Далее скрипт определяет имя, текст и изображение от webhook и исходя из них получает pipeline ```(функция get_pipeline в amo.py)```. Если pipeline None - данный pipeline мы не обрабатываем
3) Потом проверяем что сообщение не повторное (глюк amo) и проверяем не была ли это тестовая команда ```/restart``` (если она, то обнуляется база и выходит из скрипта)
4) После этого сообщение переводится (если оно не русское) ```(в файле misc.py функция translate_to_russian)```
5) Далее исходное сообщение добавляется в базу данных (```db.add_message```)
6) На данном этапе отправляется перевод сообщения в AMO (```amo.send_notes```)
7) После этого формируется запрос: читается аннотация (```misc.get_annotation```) и история сообщений (```db.read_history```)
8) Отправляется запрос к chatgpt
9) Ответ переводится (аналогично как и ранее с проверкой символов)
10) Аналогично отправляется и заметка в amo
11) Ответ сохраняется в базу данных ```db.add_message```
12) Все ;)